name: Runner
on: [ push, pull_request ]

jobs:
    static-checks:
        name: 📊 静态检查
        uses: ./.github/workflows/static-check.yml

    clang-format:
        name: 代码格式化
        permissions:
            actions: read
            checks: read
            contents: write
        needs: static-checks
        if: ${{ success() && needs.static-checks.outputs.exit_code != 0 }}
        uses: ./.github/workflows/clang-format.yml

    check-commit-release:
        name: 检查是否为发布状态
        if: always()
        runs-on: ubuntu-latest
        outputs:
            release: ${{ steps.check_commit_msg.outputs.release }}
        steps:
            - name: 检查 Commit 信息
              id: check_commit_msg
              run: |
                echo "release=${{ contains(github.event.head_commit.message, '[Release]') || contains(github.event.head_commit.message, '[All]') || github.event_name == 'pull_request' }}" >> "$GITHUB_OUTPUT"
            - name: 输出结果
              run: |
                echo "true 时打开 release, false 时仅运行 debug"
                echo ${{ steps.check_commit_msg.outputs.release }}

    cmake_matrix_debug:
        name: CMake 矩阵编译 (Debug)
        needs: [clang-format, static-checks]
        if: ${{ (success() || needs.clang-format.result == 'skipped' || needs.clang-format.result == 'success') && needs.static-checks.result == 'success' }}
        uses: ./.github/workflows/cmake-matrix-debug.yml

    cmake_matrix_release:
        name: CMake 矩阵编译 (Release)
        needs: [clang-format, static-checks, check-commit-release]
        if: ${{ (success() || needs.clang-format.result == 'skipped' || needs.clang-format.result == 'success') && needs.static-checks.result == 'success' && (needs.check-commit-release.outputs.release == 'true' || needs.check-commit-release.outputs.release == true || needs.check-commit-release.outputs.release == 1) }}
        uses: ./.github/workflows/cmake-matrix-release.yml

    test_output:
        name: 测试输出
        needs: [cmake_matrix_debug]
        if: ${{ always() }}
        runs-on: ubuntu-latest
        steps:
            - name: 输出变量
              run: |
                echo "Windows: ${{ needs.cmake_matrix_debug.outputs.success_win }}"
                echo "Unix: ${{ needs.cmake_matrix_debug.outputs.success_unix }}"

    gtest_unix:
        name: gtest 测试 (Unix)
        needs: [cmake_matrix_debug]
        if: ${{ success() || (needs.cmake_matrix_debug.outputs.success_unix == 1) }}
        uses: ./.github/workflows/cmake-matrix-test-unix.yml

    fetch_latest_ref:
        name: 仓库克隆
        runs-on: ubuntu-latest
        if: always()
        steps:
          - name: 下载分支
            uses: actions/checkout@v3
            with:
                fetch-depth: 10
          - name: 上传 Artifact
            uses: actions/upload-artifact@v3.1.2
            with:
                name: code-${{ github.ref }}-${{ github.sha }}
                path: ${{ github.workspace }}
          